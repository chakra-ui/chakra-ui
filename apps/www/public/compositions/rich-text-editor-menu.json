{
  "type": "composition",
  "npmDependencies": [
    "@floating-ui/react",
    "@tiptap/pm",
    "@tiptap/react",
    "react-icons"
  ],
  "fileDependencies": [],
  "id": "rich-text-editor-menu",
  "file": {
    "name": "rich-text-editor-menu.tsx",
    "content": "import {\n  Box,\n  Circle,\n  HStack,\n  Portal,\n  Span,\n  Stack,\n  Text,\n  mergeRefs,\n  useSlotRecipe,\n} from \"@chakra-ui/react\"\nimport {\n  autoUpdate,\n  flip,\n  offset,\n  shift,\n  useFloating,\n} from \"@floating-ui/react\"\nimport { PluginKey } from \"@tiptap/pm/state\"\nimport { ReactRenderer } from \"@tiptap/react\"\nimport * as React from \"react\"\nimport { LuHash, LuUser } from \"react-icons/lu\"\n\ninterface SuggestionItem {\n  id: string\n  label: string\n}\n\nexport interface MentionItem extends SuggestionItem {\n  email: string\n}\n\nexport interface CommandItem extends SuggestionItem {\n  description: string\n  icon: typeof LuHash\n}\n\nexport interface HashtagItem extends SuggestionItem {\n  description: string\n}\n\nexport interface EmojiItem {\n  name: string\n  shortcodes: string[]\n  tags: string[]\n  group?: string\n  emoji?: string\n  fallbackImage?: string\n}\n\nexport interface FloatingMenuProps<T = any> {\n  items: T[]\n  selectedIndex: number\n  onSelect: (item: T) => void\n  clientRect?: (() => DOMRect | null) | null | undefined\n}\n\nexport function useEditorMenu() {\n  const [selectedIndex, setSelectedIndex] = React.useState(0)\n\n  const handleKeyDown = React.useCallback(\n    (event: KeyboardEvent, items: any[], onSelect: (item: any) => void) => {\n      if (event.key === \"ArrowUp\") {\n        setSelectedIndex((prev) => (prev - 1 + items.length) % items.length)\n        return true\n      }\n      if (event.key === \"ArrowDown\") {\n        setSelectedIndex((prev) => (prev + 1) % items.length)\n        return true\n      }\n      if (event.key === \"Enter\") {\n        const item = items[selectedIndex]\n        if (item) onSelect(item)\n        return true\n      }\n      if (event.key === \"Escape\") return true\n      return false\n    },\n    [selectedIndex],\n  )\n\n  const resetSelection = React.useCallback(() => {\n    setSelectedIndex(0)\n  }, [])\n\n  return {\n    selectedIndex,\n    handleKeyDown,\n    resetSelection,\n    setSelectedIndex,\n  }\n}\n\nfunction useMenuPosition(\n  clientRect: (() => DOMRect | null) | null | undefined,\n) {\n  const [virtualElement, setVirtualElement] = React.useState<{\n    getBoundingClientRect: () => DOMRect\n  } | null>(null)\n\n  const { refs, floatingStyles } = useFloating({\n    placement: \"bottom-start\",\n    middleware: [\n      offset(8),\n      flip({\n        fallbackPlacements: [\"top-start\", \"bottom-end\", \"top-end\"],\n      }),\n      shift({ padding: 8 }),\n    ],\n    whileElementsMounted: autoUpdate,\n  })\n\n  React.useEffect(() => {\n    if (virtualElement) {\n      refs.setReference(virtualElement as any)\n    }\n  }, [virtualElement, refs])\n\n  React.useEffect(() => {\n    const rect = clientRect?.()\n    if (rect) {\n      setVirtualElement({\n        getBoundingClientRect: () => rect,\n      })\n    } else {\n      setVirtualElement(null)\n    }\n  }, [clientRect])\n\n  return {\n    refs,\n    floatingStyles,\n    isPositioned: !!virtualElement,\n  }\n}\n\n/* -----------------------------------------------------------------------------\n * Shared render factory for suggestion menus\n * -------------------------------------------------------------------------- */\n\nfunction createSuggestionRender<T>(\n  MenuComponent: React.ComponentType<FloatingMenuProps<T>>,\n) {\n  return () => {\n    let component: ReactRenderer<HTMLDivElement, FloatingMenuProps<T>> | null =\n      null\n    let container: HTMLDivElement | null = null\n    let selectedIndex = 0\n\n    return {\n      onStart(props: any) {\n        selectedIndex = 0\n        container = document.createElement(\"div\")\n        document.body.appendChild(container)\n\n        component = new ReactRenderer(MenuComponent, {\n          props: {\n            items: props.items,\n            selectedIndex,\n            onSelect: (item: T) => props.command(item),\n            clientRect: props.clientRect,\n          },\n          editor: props.editor,\n        })\n\n        container.appendChild(component.element)\n      },\n\n      onUpdate(props: any) {\n        if (!component) return\n        component.updateProps({\n          items: props.items,\n          selectedIndex,\n          onSelect: (item: T) => props.command(item),\n          clientRect: props.clientRect,\n        })\n      },\n\n      onKeyDown({ event }: { event: KeyboardEvent }) {\n        if (!component) return false\n\n        const itemCount = component.props.items.length\n\n        if (event.key === \"ArrowUp\") {\n          selectedIndex = (selectedIndex - 1 + itemCount) % itemCount\n          component.updateProps({ ...component.props, selectedIndex })\n          return true\n        }\n\n        if (event.key === \"ArrowDown\") {\n          selectedIndex = (selectedIndex + 1) % itemCount\n          component.updateProps({ ...component.props, selectedIndex })\n          return true\n        }\n\n        if (event.key === \"Enter\") {\n          const item = component.props.items[selectedIndex]\n          if (item) component.props.onSelect(item)\n          return true\n        }\n\n        if (event.key === \"Escape\") return true\n\n        return false\n      },\n\n      onExit() {\n        container?.remove()\n        container = null\n        component?.destroy()\n        component = null\n      },\n    }\n  }\n}\n\n/* -----------------------------------------------------------------------------\n * Menu Components\n * -------------------------------------------------------------------------- */\n\nexport const MentionMenu = React.forwardRef<\n  HTMLDivElement,\n  FloatingMenuProps<MentionItem>\n>(function MentionMenu(props, ref) {\n  const { items, selectedIndex, onSelect, clientRect } = props\n  const { refs, floatingStyles, isPositioned } = useMenuPosition(clientRect)\n\n  const menuRecipe = useSlotRecipe({ key: \"menu\" })\n  const styles = menuRecipe({ size: \"md\" })\n\n  const selectedRef = React.useRef<HTMLDivElement | null>(null)\n\n  React.useEffect(() => {\n    selectedRef.current?.scrollIntoView({ block: \"nearest\" })\n  }, [selectedIndex])\n\n  if (!isPositioned) return null\n\n  return (\n    <Portal>\n      <Box\n        ref={mergeRefs(refs.setFloating, ref)}\n        style={floatingStyles}\n        css={styles.content}\n        role=\"listbox\"\n        aria-label=\"User mentions\"\n      >\n        {items.length === 0 ? (\n          <Box p=\"3\" textAlign=\"center\">\n            <Text textStyle=\"sm\" color=\"fg.muted\">\n              No users found\n            </Text>\n          </Box>\n        ) : (\n          items.map((item, index) => (\n            <Box\n              key={item.id}\n              ref={index === selectedIndex ? selectedRef : undefined}\n              css={styles.item}\n              onPointerDown={(event) => {\n                event.preventDefault()\n                onSelect(item)\n              }}\n              data-highlighted={index === selectedIndex ? \"\" : undefined}\n              role=\"option\"\n              aria-selected={index === selectedIndex}\n            >\n              <HStack gap=\"2.5\" w=\"full\">\n                <Circle size=\"8\" layerStyle=\"fill.muted\">\n                  <LuUser size={16} />\n                </Circle>\n                <Stack align=\"start\" gap=\"0\" flex=\"1\" minW=\"0\">\n                  <Span textStyle=\"sm\" fontWeight=\"medium\">\n                    {item.label}\n                  </Span>\n                  <Span textStyle=\"xs\" color=\"fg.muted\">\n                    {item.email}\n                  </Span>\n                </Stack>\n              </HStack>\n            </Box>\n          ))\n        )}\n      </Box>\n    </Portal>\n  )\n})\n\nexport const SuggestionMenu = React.forwardRef<\n  HTMLDivElement,\n  FloatingMenuProps<CommandItem | HashtagItem>\n>(function SuggestionMenu(props, ref) {\n  const { items, selectedIndex, onSelect, clientRect } = props\n  const { refs, floatingStyles, isPositioned } = useMenuPosition(clientRect)\n\n  const selectedRef = React.useRef<HTMLDivElement | null>(null)\n  const menuRecipe = useSlotRecipe({ key: \"menu\" })\n  const styles = menuRecipe({ size: \"md\" })\n\n  React.useEffect(() => {\n    selectedRef.current?.scrollIntoView({ block: \"nearest\" })\n  }, [selectedIndex])\n\n  if (!isPositioned) return null\n\n  return (\n    <Portal>\n      <Box\n        ref={mergeRefs(refs.setFloating, ref)}\n        style={floatingStyles}\n        css={styles.content}\n        role=\"listbox\"\n        aria-label=\"Suggestions\"\n      >\n        {items.length === 0 ? (\n          <Box p=\"3\" textAlign=\"center\">\n            <Text textStyle=\"sm\" color=\"fg.muted\">\n              No suggestions found\n            </Text>\n          </Box>\n        ) : (\n          items.map((item: CommandItem | HashtagItem, index) => {\n            const isCommand = \"icon\" in item\n            const Icon = isCommand ? (item as CommandItem).icon : LuHash\n\n            return (\n              <Box\n                key={item.id}\n                ref={index === selectedIndex ? selectedRef : undefined}\n                css={styles.item}\n                onPointerDown={(event) => {\n                  event.preventDefault()\n                  onSelect(item)\n                }}\n                data-highlighted={index === selectedIndex ? \"\" : undefined}\n                role=\"option\"\n                aria-selected={index === selectedIndex}\n              >\n                <HStack gap=\"2.5\" w=\"full\">\n                  <Circle size=\"8\" layerStyle=\"fill.muted\">\n                    <Icon size={16} />\n                  </Circle>\n                  <Stack align=\"start\" gap=\"0\" flex=\"1\" minW=\"0\">\n                    <Span textStyle=\"sm\" fontWeight=\"medium\">\n                      {isCommand ? item.label : `#${item.label}`}\n                    </Span>\n                    <Span textStyle=\"xs\" color=\"fg.muted\">\n                      {item.description}\n                    </Span>\n                  </Stack>\n                </HStack>\n              </Box>\n            )\n          })\n        )}\n      </Box>\n    </Portal>\n  )\n})\n\nexport const EmojiMenu = React.forwardRef<\n  HTMLDivElement,\n  FloatingMenuProps<EmojiItem>\n>(function EmojiMenu(props, ref) {\n  const { items, selectedIndex, onSelect, clientRect } = props\n  const { refs, floatingStyles, isPositioned } = useMenuPosition(clientRect)\n\n  const menuRecipe = useSlotRecipe({ key: \"menu\" })\n  const styles = menuRecipe({ size: \"md\" })\n\n  const selectedRef = React.useRef<HTMLDivElement | null>(null)\n\n  React.useEffect(() => {\n    selectedRef.current?.scrollIntoView({ block: \"nearest\" })\n  }, [selectedIndex])\n\n  if (!isPositioned) return null\n\n  return (\n    <Portal>\n      <Box\n        ref={mergeRefs(refs.setFloating, ref)}\n        style={floatingStyles}\n        css={styles.content}\n        role=\"listbox\"\n        aria-label=\"Emoji suggestions\"\n        maxH=\"200px\"\n      >\n        {items.length === 0 ? (\n          <Box p=\"3\" textAlign=\"center\">\n            <Text textStyle=\"sm\" color=\"fg.muted\">\n              No emojis found\n            </Text>\n          </Box>\n        ) : (\n          items.map((item, index) => (\n            <Box\n              key={item.name}\n              ref={index === selectedIndex ? selectedRef : undefined}\n              css={styles.item}\n              onPointerDown={(event) => {\n                event.preventDefault()\n                onSelect(item)\n              }}\n              data-highlighted={index === selectedIndex ? \"\" : undefined}\n              role=\"option\"\n              aria-selected={index === selectedIndex}\n            >\n              <HStack gap=\"2.5\" w=\"full\">\n                <Circle size=\"8\" layerStyle=\"fill.muted\" fontSize=\"lg\">\n                  {item.emoji || \"‚ùì\"}\n                </Circle>\n                <Span textStyle=\"sm\" fontWeight=\"medium\">\n                  :{item.shortcodes[0]}:\n                </Span>\n              </HStack>\n            </Box>\n          ))\n        )}\n      </Box>\n    </Portal>\n  )\n})\n\n/* -----------------------------------------------------------------------------\n * Config Factories\n * -------------------------------------------------------------------------- */\n\nexport const createMentionConfig = (users: MentionItem[]) => {\n  return {\n    char: \"@\",\n    pluginKey: new PluginKey(\"mention\"),\n    items: ({ query }: { query: string }) =>\n      users.filter((user) =>\n        user.label.toLowerCase().includes(query.toLowerCase()),\n      ),\n    render: createSuggestionRender(MentionMenu),\n  }\n}\n\nexport const createSuggestionConfig = (\n  char: string,\n  getItems: (query: string) => (CommandItem | HashtagItem)[],\n) => {\n  return {\n    char,\n    pluginKey: new PluginKey(`suggestion-${char}`),\n    items: ({ query }: { query: string }) => getItems(query),\n    render: createSuggestionRender(SuggestionMenu),\n  }\n}\n\nexport const createEmojiSuggestionConfig = (\n  allEmojis: EmojiItem[],\n  options?: { maxResults?: number },\n) => {\n  const maxResults = options?.maxResults ?? 10\n\n  return {\n    char: \":\",\n    pluginKey: new PluginKey(\"emoji-suggestion\"),\n    items: ({ query }: { query: string }) => {\n      if (!query) return allEmojis.slice(0, maxResults)\n      const lowerQuery = query.toLowerCase()\n      return allEmojis\n        .filter(\n          (emoji) =>\n            emoji.shortcodes.some((sc) => sc.includes(lowerQuery)) ||\n            emoji.tags.some((tag) => tag.includes(lowerQuery)),\n        )\n        .slice(0, maxResults)\n    },\n    render: createSuggestionRender(EmojiMenu),\n  }\n}\n"
  },
  "component": "RichTextEditorMenu"
}